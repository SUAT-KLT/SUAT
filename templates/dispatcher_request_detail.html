<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали заявки</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        .form-section {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background-color: #f8f9fa;
}

.form-section h6 {
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #0d6efd;
    font-weight: 600;
}

input[type="datetime-local"] {
    cursor: pointer;
}

input[type="datetime-local"]:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}
        .attachment-badge {
            cursor: pointer;
        }
        .comment-box {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 0 4px 4px 0;
        }
        .zoom-controls {
            display: flex;
            align-items: center;
        }
        #imageViewerContainer {
            touch-action: none;
            user-select: none;
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        .image-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #attachmentImage {
            transition: transform 0.1s ease;
            cursor: grab;
            max-width: none;
            transform-origin: 0 0;
            display: none;
            position: absolute;
        }
        #attachmentViewer {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .modal-body {
            padding: 0;
            height: calc(100% - 120px);
        }
        .form-section {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.form-section h6 {
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">СУАТ ООО "КУЛТУМИНСКОЕ"</a>
            <div class="d-flex">
                {% if logged_in %}
                    {% if is_admin %}
                        <a href="{{ url_for('manage_users') }}" class="btn btn-outline-light me-2">Управление пользователями</a>
                    {% endif %}
                    {% if is_dispatcher %}
                        <a href="{{ url_for('dispatcher_requests') }}" class="btn btn-outline-light me-2">Управление заявками</a>
                    {% endif %}
                    <span class="navbar-text me-3">Вы вошли как: {{ session['user_login'] }}</span>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Выйти</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline-light">Войти</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">Детали заявки #{{ request.request_id }}</h1>

        {% if approval.approval_status == 'Pending' and is_overlapping %}
        <div class="alert alert-warning">
            <strong>Внимание:</strong> Этот транспорт уже забронирован на указанное время.
            Вы не можете одобрить эту заявку, пока не измените время или транспорт.
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h5>Информация о заявке</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Сотрудник:</strong> {{ request.employee.surname }} {{ request.employee.firstname }} {{ request.employee.secondname or '' }}</p>
                        <p><strong>Подразделение:</strong> {{ request.employee.department }}</p>
                        <p><strong>Должность:</strong> {{ request.employee.job_title }}</p>
                        <p><strong>Телефон:</strong> {{ request.phone_number }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Транспорт:</strong> {{ request.transport.tsname }} ({{ request.transport.tsnumber }})</p>
                        <p><strong>Время:</strong> {{ request.booking_datetime.strftime('%d.%m.%Y %H:%M') }} - {{ request.booking_end.strftime('%d.%m.%Y %H:%M') }}</p>
                        <p><strong>Маршрут:</strong> {{ request.loc_from }} → {{ request.loc_to }}</p>
                        <p><strong>Дата создания:</strong> {{ request.request_datetime.strftime('%d.%m.%Y %H:%M') }}</p>
                    </div>
                </div>
                <p><strong>Цель поездки:</strong> {{ request.purpose }}</p>

                {% if has_attachment %}
                <div class="mt-3">
                    <strong>Прикрепленный файл:</strong>
                    <button type="button" class="btn btn-sm btn-info ms-2 view-attachment-btn"
                            data-request-id="{{ request.request_id }}"
                            data-file-name="{{ request.attachment_filename }}">
                            Просмотреть файл
                    </button>
                    <a href="{{ url_for('download_attachment', request_id=request.request_id) }}?download=true"
                       class="btn btn-sm btn-secondary ms-2">
                        Скачать файл
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
    <div class="card-header">
        <h5>Управление заявкой</h5>
    </div>
    <div class="card-body">
        <!-- Форма изменения времени -->
<div class="form-section">
    <h6>Изменение времени бронирования</h6>
    <form method="POST" action="{{ url_for('dispatcher_request_detail', request_id=request.request_id) }}">
        {{ time_form.hidden_tag() }}
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="booking_datetime" class="form-label">Начало</label>
                    <input type="datetime-local" class="form-control" id="booking_datetime"
                           name="booking_datetime"
                           value="{{ request.booking_datetime.strftime('%Y-%m-%dT%H:%M') }}"
                           required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="booking_end" class="form-label">Окончание</label>
                    <input type="datetime-local" class="form-control" id="booking_end"
                           name="booking_end"
                           value="{{ request.booking_end.strftime('%Y-%m-%dT%H:%M') }}"
                           required>
                </div>
            </div>
        </div>
        <button type="submit" name="time_submit" class="btn btn-warning">Изменить время</button>
    </form>
</div>

        <hr>

        <!-- Форма изменения статуса -->
        <h6>Изменение статуса и транспорта</h6>
        <form method="POST" action="{{ url_for('dispatcher_request_detail', request_id=request.request_id) }}">
            {{ form.hidden_tag() }}

            <div class="mb-3">
                {{ form.status.label(class="form-label") }}
                {{ form.status(class="form-select") }}
            </div>

            <div class="mb-3">
                {{ form.transport_id.label(class="form-label") }}
                {{ form.transport_id(class="form-select") }}
            </div>

            <div class="mb-3">
                {{ form.comment.label(class="form-label") }}
                {{ form.comment(class="form-control", rows=3) }}
            </div>

            <button type="submit" name="status_submit" class="btn btn-primary">Сохранить изменения статуса</button>
            <a href="{{ url_for('dispatcher_requests') }}" class="btn btn-secondary ms-2">Назад к списку</a>
        </form>

        {% if approval.comment %}
        <div class="comment-box mt-3">
            <strong>Комментарий:</strong>
            <p>{{ approval.comment }}</p>
        </div>
        {% endif %}
    </div>
</div>
    </div>

    <!-- Модальное окно для просмотра файла -->
    <div class="modal fade" id="attachmentModal" tabindex="-1" aria-labelledby="attachmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header">
                    <h5 class="modal-title" id="attachmentModalLabel">Просмотр файла</h5>
                    <div class="zoom-controls ms-auto">
                        <span class="zoom-level mx-2">100%</span>
                        <button id="resetZoomBtn" class="btn btn-sm btn-outline-secondary ms-2">Сбросить</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 bg-dark">
                    <div id="imageViewerContainer">
                        <div class="image-wrapper">
                            <img id="attachmentImage" style="position:absolute; max-width:none; transform-origin:0 0; display:none;">
                            <iframe id="attachmentViewer" style="width:100%; height:100%; border:none; display:none;"></iframe>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <a id="downloadAttachmentBtn" class="btn btn-primary" download>Скачать</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    $(document).ready(function() {
        // Инициализация Select2
        $('.select2').select2({
            placeholder: 'Выберите транспорт',
            width: '100%'
        });

        // Установка минимальной даты для полей ввода
        function setMinDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

            $('input[type="datetime-local"]').attr('min', minDateTime);
        }

        // Вызываем при загрузке страницы
        setMinDateTime();

        // Обновляем минимальное время каждую минуту
        setInterval(setMinDateTime, 60000);

        // Валидация времени при изменении
        $('form').submit(function(e) {
            const submitButton = $(document.activeElement);

            // Валидация для формы изменения времени
            if (submitButton.attr('name') === 'time_submit') {
                const startTime = new Date($('#booking_datetime').val());
                const endTime = new Date($('#booking_end').val());
                const now = new Date();

                now.setMinutes(now.getMinutes() - 5);

                if (startTime < now) {
                    alert('Нельзя выбрать дату и время раньше текущего момента');
                    e.preventDefault();
                    return false;
                }

                if (endTime <= startTime) {
                    alert('Время окончания должно быть позже времени начала');
                    e.preventDefault();
                    return false;
                }
            }

            // Переменные для управления масштабированием и перемещением
            let scale = 1;
            let posX = 0;
            let posY = 0;
            let isDragging = false;
            let startX, startY;
            let isImage = false;

            // Инициализация модального окна
            const attachmentModal = new bootstrap.Modal(document.getElementById('attachmentModal'));

            // Обработка просмотра файла
            $(document).on('click', '.view-attachment-btn', function() {
                const requestId = $(this).data('request-id');
                const url = `/request/${requestId}/attachment`;

                // Сброс предыдущего состояния
                $('#attachmentImage').hide().attr('src', '');
                $('#attachmentViewer').hide().attr('src', '');

                // Проверка типа файла
                $.ajax({
                    url: url,
                    type: 'HEAD',
                    success: function(data, status, xhr) {
                        const contentType = xhr.getResponseHeader('Content-Type');
                        if (contentType && contentType.startsWith('image/')) {
                            isImage = true;
                            $('#attachmentViewer').hide();
                            $('#attachmentImage').show().attr('src', url);
                            resetImageZoom();
                        } else {
                            isImage = false;
                            $('#attachmentImage').hide();
                            $('#attachmentViewer').show().attr('src', url);
                        }
                        attachmentModal.show();
                    }
                });

                $('#downloadAttachmentBtn').attr('href', url + '?download=true');
            });

            // Сброс масштаба и позиции
            function resetImageZoom() {
                if (!isImage) return;

                const container = $('#imageViewerContainer');
                const img = $('#attachmentImage');

                // Получаем размеры
                const containerWidth = container.width();
                const containerHeight = container.height();
                const imgWidth = img[0].naturalWidth;
                const imgHeight = img[0].naturalHeight;

                // Вычисляем масштаб для вписывания
                const scaleX = containerWidth / imgWidth;
                const scaleY = containerHeight / imgHeight;
                scale = Math.min(scaleX, scaleY);

                // Центрируем изображение
                posX = (containerWidth - imgWidth * scale) / 2;
                posY = (containerHeight - imgHeight * scale) / 2;

                applyTransform();
                updateZoomLevel();
            }

            // Применение трансформации
            function applyTransform() {
                $('#attachmentImage').css({
                    'transform': `translate(${posX}px, ${posY}px) scale(${scale})`,
                    'left': '0',
                    'top': '0'
                });
            }

            // Обновление отображения масштаба
            function updateZoomLevel() {
                $('.zoom-level').text(`${Math.round(scale * 100)}%`);
            }

            // Обработка колесика мыши
            $('#imageViewerContainer').on('wheel', function(e) {
                if (!isImage) return;
                e.preventDefault();

                const delta = e.originalEvent.deltaY > 0 ? -0.1 : 0.1;
                const oldScale = scale;

                // Масштабируем с ограничениями
                scale = Math.max(0.1, Math.min(scale + delta, 5));

                // Корректируем позицию для масштабирования к курсору
                const mouseX = e.originalEvent.clientX - $(this).offset().left;
                const mouseY = e.originalEvent.clientY - $(this).offset().top;

                posX = mouseX - (mouseX - posX) * (scale / oldScale);
                posY = mouseY - (mouseY - posY) * (scale / oldScale);

                applyTransform();
                updateZoomLevel();
            });

            // Перетаскивание изображения
            $('#attachmentImage').on('mousedown', function(e) {
                if (!isImage) return;
                isDragging = true;
                startX = e.clientX - posX;
                startY = e.clientY - posY;
                $(this).css('cursor', 'grabbing');
            });

            $(document).on('mousemove', function(e) {
                if (!isDragging || !isImage) return;
                posX = e.clientX - startX;
                posY = e.clientY - startY;
                applyTransform();
            });

            $(document).on('mouseup', function() {
                if (!isImage) return;
                isDragging = false;
                $('#attachmentImage').css('cursor', 'grab');
            });

            // Сброс масштаба
            $('#resetZoomBtn').click(resetImageZoom);

            // При открытии модального окна
            $('#attachmentModal').on('shown.bs.modal', function() {
                if (isImage) {
                    $('#attachmentImage').css('cursor', 'grab');
                    resetImageZoom();
                }
            });

            // При закрытии модального окна
            $('#attachmentModal').on('hidden.bs.modal', function() {
                isDragging = false;
            });

    // Валидация для формы изменения статуса (существующий код)
    if (submitButton.attr('name') === 'status_submit') {
        const status = $('#status').val();
        const transportId = $('#transport_id').val();
        const originalTransportId = {{ request.transport_id }};

        // Если статус "Approved" и транспорт был изменен
        if (status === 'Approved' && transportId != 0 && transportId != originalTransportId) {
            // Проверяем доступность транспорта
            $.ajax({
                url: '/api/check_transport_available',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    transport_id: transportId
                }),
                success: function(response) {
                    if (!response.is_available) {
                        alert('Невозможно назначить этот транспорт: он недоступен');
                        e.preventDefault();
                        return false;
                    }

                    // Если транспорт доступен, проверяем наложения
                    const startTime = '{{ request.booking_datetime.strftime("%Y-%m-%d %H:%M:%S") }}';
                    const endTime = '{{ request.booking_end.strftime("%Y-%m-%d %H:%M:%S") }}';
                    const requestId = {{ request.request_id }};

                    $.ajax({
                        url: '/api/check_booking_overlap',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            transport_id: transportId,
                            start_time: startTime,
                            end_time: endTime,
                            exclude_request_id: requestId
                        }),
                        success: function(response) {
                            if (response.overlap) {
                                alert('Невозможно одобрить заявку: новый транспорт уже забронирован на это время');
                                e.preventDefault();
                            } else {
                                $('form').unbind('submit').submit();
                            }
                        }
                    });
                }
            });
            return false;
        }
    }
});

// Установка минимальной даты для полей ввода времени
function setMinDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 5);

    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

    $('input[type="datetime-local"]').attr('min', minDateTime);
}

// Вызываем при загрузке страницы
setMinDateTime();

// Обновляем минимальное время каждую минуту
setInterval(setMinDateTime, 60000);

            // Вызываем при загрузке страницы
            setMinDateTime();

            // Обновляем минимальное время каждую минуту
            setInterval(setMinDateTime, 60000);

            // Валидация даты при отправке формы
            $('form').submit(function(e) {
                const startTime = new Date($('#booking_datetime').val());
                const endTime = new Date($('#booking_end').val());
                const now = new Date();

                now.setMinutes(now.getMinutes() - 5);

                if (startTime < now) {
                    alert('Нельзя выбрать дату и время раньше текущего момента');
                    e.preventDefault();
                    return false;
                }

                if (endTime <= startTime) {
                    alert('Время окончания должно быть позже времени начала');
                    e.preventDefault();
                    return false;
                }
            });
        });
$('form').submit(function(e) {
    const status = $('#status').val();
    const transportId = $('#transport_id').val();
    const originalTransportId = {{ request.transport_id }};

    // Если статус "Approved" и транспорт был изменен
    if (status === 'Approved' && transportId != 0 && transportId != originalTransportId) {
        // Проверяем доступность транспорта
        $.ajax({
            url: '/api/check_transport_available',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                transport_id: transportId
            }),
            success: function(response) {
                if (!response.is_available) {
                    alert('Невозможно назначить этот транспорт: он недоступен');
                    e.preventDefault();
                    return false;
                }

                // Если транспорт доступен, проверяем наложения
                const startTime = '{{ request.booking_datetime.strftime("%Y-%m-%d %H:%M:%S") }}';
                const endTime = '{{ request.booking_end.strftime("%Y-%m-%d %H:%M:%S") }}';
                const requestId = {{ request.request_id }};

                $.ajax({
                    url: '/api/check_booking_overlap',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        transport_id: transportId,
                        start_time: startTime,
                        end_time: endTime,
                        exclude_request_id: requestId
                    }),
                    success: function(response) {
                        if (response.overlap) {
                            alert('Невозможно одобрить заявку: новый транспорт уже забронирован на это время');
                            e.preventDefault();
                        } else {
                            $('form').unbind('submit').submit();
                        }
                    }
                });
            }
        });
        return false;
    }
});
    </script>
</body>
</html>